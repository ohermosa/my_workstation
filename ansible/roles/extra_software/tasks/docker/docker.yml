---

- include_tasks: "docker_{{ linux_distribution }}.yml"

- name: "[DOCKER] Adding {{ ansible_user }} to group docker"
  user:
    name: "{{ ansible_user }}"
    groups: docker
    append: true

- name: "[DOCKER] Restart Docker"
  systemd:
    name: docker
    enabled: true
    state: restarted

- name: "[DOCKER_COMPOSE] Install docker compose"
  block:
    - name: "[DOCKER_COMPOSE] Get latest version of Docker Compose"
      uri:
        url: "{{ dockercompose_latest_url }}"
        follow_redirects: safe
        body_format: raw
      register: dockercompose_latest
      when: linux_distribution != "arch"

    - name: "[DOCKER_COMPOSE] Set urls for Docker Compose packages"
      vars:
        dockercompose_version: "{{ dockercompose_latest.url | urlsplit('path') | basename }}"
      set_fact:
        dockercompose_package: "https://github.com/docker/compose/releases/download/{{ dockercompose_version }}/docker-compose-{{ ansible_system }}-{{ ansible_architecture }}"
      when: linux_distribution != "arch"

    - name: "[DOCKER_COMPOSE] Download Docker Compose binary"
      import_tasks: docker_compose.yml
      when: linux_distribution != "arch"
  tags:
    - dockercompose

- name: "[DIVE] Install Dive"
  block:
    - name: "[DIVE] Get latest version of Dive"
      uri:
        url: "{{ dive_latest_url }}"
      register: dive_response
      when: linux_distribution != "arch"

    - name: "[DIVE] Set urls for Dive packages"
      vars:
        dive_version: "{{ dive_response.json.tag_name }}"
      set_fact:
        dive_deb_package: "https://github.com/wagoodman/dive/releases/download/{{ dive_version }}/dive_{{ dive_version[1:] }}_linux_amd64.deb"
        dive_rpm_package: "https://github.com/wagoodman/dive/releases/download/{{ dive_version }}/dive_{{ dive_version[1:] }}_linux_amd64.rpm"
      when: linux_distribution != "arch"

    - name: "[DIVE] Download Dive"
      include_tasks: "dive_{{ linux_distribution }}.yml"
  tags:
    - dive
